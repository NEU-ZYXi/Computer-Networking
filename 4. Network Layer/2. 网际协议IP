
4.2 网际协议IP
  网际协议IP是TCP/IP体系中两个最主要的协议之一，与四个协议配套使用：
    1. 地址解析协议(address resolution protocol,ARP)
    2. 逆地址解析协议(reverse address resolution protocol,RARP)
    3. 网际控制报文协议(internet control message protocol,ICMP)
    4. 网际组管理协议(internet group management protocol,IGMP)
    
  1. 虚拟互连网络
    由于没有一种单一的网络能够适应所有用户的需求，需要使用一些中间设备将网络互相连接起来
     
    (1). 物理层使用的中间设备是转发器(repeater)
    (2). 数据链路层使用的中间设备是网桥或桥接器(bridge)
    (3). 网络层使用的中间设备是路由器(router)
    (4). 在网络层以上使用的中间设备是网关(gateway)，用网关连接两个不兼容的系统需要在高层进行协议的转换
    
    TCP/IP体系在网络互连上采用的做法是在网络层，即IP层，采用标准化协议
    由于参加互连的计算机网络都使用相同的网际协议IP(internet protocol)，因此可以把互连以后的计算机网络称为一个虚拟互连网络
    虚拟互连网络是逻辑互连网络，即利用IP协议使各种异构的物理网络在网络层里看起来像是一个统一的网络，不显示具体的异构细节
    
  2. 分类的IP地址
    整个因特网是一个单一的、抽象的网络，IP地址是给因特网上每一个主机的每一个接口分配一个在全世界范围唯一的32位的标识符
    
    (1). 分类的IP地址：指将IP地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成：
      1). 网络号(net-id)：标志主机所连接到的网络，在整个因特网范围内是唯一的
      2). 主机号(host-id)：标志该主机，在网络号所指的网络范围内是惟一的
      
    (2). 常分为A类、B类和C类地址，都是单播地址，即一对一通信，但如今已不再使用
      1). A类地址的网络号字段占一个字节，从1-126
      2). B类地址的网络号字段占两个字节，从128.1.0.0-191.255.0.0
      3). C类地址的网络号字段占三个字节，从192.0.1.0-223.255.255.0
      
    (3). IP地址的特点
      1). 由于每一个IP地址都由网络号和主机号两部分组成，则IP地址是一种分等级的地址结构
          IP地址管理机构只分配网络号，主机号由得到该网络号的机构分配，方便管理
          路由器仅根据目的主机所连接的网络号来转发分组，减小路由表所占的存储空间和查找路由表的时间
      2). IP地址是标志一个主机和一条链路的接口，当一个主机同时连接到多个网络上时，该主机需要同时有多个相应的IP地址，称为多归属主机
      3). 一个网络是具有相同网络号的主机的集合，则用转发器或网桥连接起来的若干个局域网也是一个网络
      4). 在IP地址中，所有分配到网络号的网络都是平等的
      
  3. IP地址和硬件地址      
    物理地址是数据链路层和物理层使用的地址，放在MAC帧的首部
    IP地址是网络层和以上各层使用的地址，是一种逻辑地址，放在IP数据报的首部
    
    1). 在IP层抽象的互联网上只能看到IP数据报
    2). 路由器只根据目的站的IP地址的网络号进行路由选择
    3). 在局域网的链路层，只能看见MAC帧，IP数据报被封装在MAC帧中
    4). IP层抽象的互联网屏蔽了硬件地址体系的细节，能够使用统一的、抽象的IP地址研究主机和主机或路由器之间的通信
  
  4. 地址解析协议ARP和逆地址解析协议RARP
    IP地址 ——> ARP ——> 物理地址
    物理地址 ——> RARP ——> IP地址
    
    ARP在主机ARP高速缓存中存放一个从IP地址到硬件地址的映射表，并进行动态更新
    当主机A要向本局域网上的某个主机B发送IP数据报时，在ARP高速缓存中查看有无主机B的地址，当查找不到时
      (1). ARP进程在本局域网上广播发送一个ARP请求分组
      (2). 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组
      (3). 主机B在ARP请求分组中见到自己的IP地址，向主机A发送ARP响应分组，并写入自己的硬件地址
      (4). 主机A收到主机B的ARP响应分组后，在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射
      (5). 对映射表设置一定的生存时间，避免因某主机的硬件地址改变而导致错误
      
    使用ARP的四种典型情况
      (1). 发送方式主机，要把IP数据报发送到本网络上的另一个主机，使用ARP找到目的主机的硬件地址
      (2). 发送方是主机，要把IP数据报发送到另一个网络上的一个主机，使用ARP找到本网络上的一个路由器的硬件地址
      (3). 发送方式路由器，要把IP数据报转发到本网络上的一个主机，使用ARP找到目的主机的硬件地址
      (4). 发送方是路由器，要把IP数据报转发到另一个网络上的一个主机，使用ARP找到本网络上的一个路由器的硬件地址
    
  5. IP数据报的格式
    由首部和数据两部分组成，首部分为20字节的固定长度和可选字段
    
    (1). 固定部分
      1). 版本，IPv4或IPv6
      2). 首部长度
      3). 区分服务，一般不起作用
      4). 总长度，不能超过数据链路层中帧格式中定义的最大传送单元(maximum trasfer unit,MTU)
      5). 标识(identification)，用来标识由于长度超过MTU而进行分片后的数据报
      6). 标志(flag)，记录还有分片(more fragment)和不能分片(don't fragment)
      7). 片偏移，指在较长的分组在分片后，某数据报片在原分组中的相对位置
      8). 生存时间(time to live,TTL)，指数据报在因特网中至多可以经过的路由器的个数
      9). 协议
      10). 首部检验和
      11). 源地址
      12). 目的地址
  
    (2). 可变部分，即可选项字段，支持排错、测量以及安全等措施
    
  6. IP层转发分组的流程
    (1). 从数据报的首部提取目的主机的IP地址D，得出目的网络地址为N
    (2). 若N是与此路由器直接相连的某个网络地址，进行直接交付，即把目的主机地址转换为具体的硬件地址，把数据报封装成MAC帧，再发送此帧
         否则，进行间接交付，执行(3)
    (3). 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中指明的下一跳路由器，否则，执行(4)
    (4). 若路由表中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器，否则，执行(5)
    (5). 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器，否则，执行(6)
    (6). 报告转发分组出错
  
  
  
      
  
  
  
