
4.5 因特网的路由选择协议
  1. 基本概念
    (1). 路由算法
      路由算法是路由选择协议的核心，用来获得路由表中的各项目
      应该是正确的、完整的、在计算上简单、能适应通信量和网络拓扑的变化、具有稳定性、公平的和在当前需求下是最佳的
      1). 静态路由选择策略：非自适应路由选择，简单并且开销较小，不能及时适应网络状态的变化
      2). 动态路由选择策略：自适应路由选择，能较好地适应网络状态的变化，实现较为复杂，开销比较大
      
    (2). 分层次的路由选择协议
      由于将过多数量的路由器互连起来的话，路由表会非常大，导致处理时间过长以及通信链路饱和，所以将互联网划分为许多个小的自治系统(autonomous system)
      自治系统：是在单一的技术管理下的一组路由器，分别使用路由选择协议来确定分组在AS内和AS之间的路由
        1). 内部网关协议(interior gateway protocol,IGP)，又称域内路由选择：自治系统内部使用的路由选择协议
        2). 外部网关协议(external gateway protocol,EGP)，又称域间路由选择：两个自治系统之间的路由选择协议
  
  2. 内部网关协议RIP
    (1). 工作原理
      路由信息协议(routing information protocol,RIP)是内部网关协议IGP中常用的协议，是一种分布式的基于距离向量的路由选择协议
      RIP协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录，这组距离即距离向量，RIP协议选择一条具有最少路由器的路由
        距离：也称为跳数，即每经过一个间接交付的路由器，跳数就加1
      
      RIP协议的特点：
        1). 仅和相邻路由器交换信息
        2). 路由器交换的信息是当前本路由器所知道的全部信息，即自己的路由表
        3). 按固定的时间间隔交换路由信息
        4). 路由表中最主要的信息是到某个网络的最短距离以及需要经过的下一跳地址
        
      距离向量算法：使用Bellmon-Ford算法找最短路径，并不断更新，使每个路由器到每一个目的网络的路由都是最短的
      
  3. RIP协议的报文格式
    RIP报文由首部和路由部分组成
    1). 首部：其中的命令字段指出该报文的意义
    2). 路由部分：由若干个路由信息组成
                 I. 地址族标识符，又称为地址类别，用来标志所使用的地址协议
                 II. 路由标记，填入自治系统号，用来使RIP能收到本自治系统意外的路由选择信息
                 III. 网络地址、子网掩码、下一跳路由器地址和到此网络的距离
    
    RIP协议的优点：实现简单，开销较小
    RIP协议的缺点：当网络出现故障时，要经过比较长的时间才能将此信息传送到所有的路由器，使更新过程的收敛时间过长
                  限制了网络的规模，能使用的最大距离为15
                  路由器之间交换的路由信息是路由器中完整的路由表，随着网络规模的扩大，开销也增加
                  
  4. 内部网关协议OSPF
     开放最短路径优先(open shortest path first,OSPF)，使用Dijkstra最短路径算法
  
    (1). 基本特点
      使用分布式的链路状态协议(link state protocol)，而不是距离向量协议
      1). 向本自治系统中所有路由器发送信息，使用洪泛法(flooding)，即路由器通过所有端口向所有相邻的路由器发送信息，层层覆盖发送
      2). 发送的信息就是与本路由器相邻的所有路由器的链路状态，即说明本路由器和哪些路由器相邻，以及该链路的度量(metric)
      3). 只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息
      
      由于各路由器之间频繁地交换链路状态信息，因此所有路由器最终建立一个链路状态数据库(link state database)，即全网拓扑结构图
      该拓扑结构在全网范围内是一致的，称为链路状态数据库的同步，每一个路由器使用Dijkstra最短路径算法通过数据库中的数据构造出自己的路由表
      
      为了使OSPF能用于规模很大的网络，将一个自治系统划分为若干个更小的范围，称为区域(area)
      划分区域的好处是把利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个自治系统，减少了网络上的通信量
      
      OSPF使用层次结构的区域划分
        1). 上层的区域称为主干区域(backbone area)，用来连通其他在下层的区域，主干区域内的路由器称为主干路由器(backbone router)
        2). 从其他区域来的信息在区域边界路由器(area border router)进行概括
        3). 在主干区域内有一个路由器专门和本自治系统外的其他自治系统交换路由信息，称为自治系统边界路由器
        
      OSPF直接用IP数据报传送，构成的数据报很短，能减少路由信息的通信量，可以不必将长的数据报分片传送从而避免了数据报丢失
      字段包括版本、类型、分组长度、路由器标识符、区域标识符、检验和、鉴别类型和鉴别
      
    (2). 分组类型
      1). 问候(hello)分组，用来发现和维持邻站的可达性
      2). 数据库描述(database description)分组，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息
      3). 链路状态请求(link state request)分组，向对方请求发送某些链路状态项目的详细信息
      4). 链路状态更新(link state update)分组，用洪泛法对全网更新链路状态，是OSPF最核心的部分
      5). 链路状态确认(link state acknowledgment)分组，对链路更新分组的确认
      
      两个相邻路由器每隔10秒交换一次问候分组，确保邻站是可达的，若不可达，应修改链路状态数据库并重新计算路由表
      其他四种分组用来进行链路状态数据库的同步，即不同路由器的链路转改数据库的内容是一样的，两个同步的路由器称为完全邻接(fully adjacent)
    
  5. 外部网关协议BGP
    边界网关协议(border gateway protocol,BGP)是不同AS的路由器之间交换路由信息的协议
    原因：(1). 因特网的规模太大，使AS之间的路由选择非常困难
              连接在因特网主干网上的路由器，对任何有效的IP地址都要在路由表中找到目的网络，当一个路由表的项目数过大时，要维持一个过大的链路状态数据库
         (2). AS之间的路由选择必须考虑有关策略，由于相互连接的网络性能相差很大，如果根据最短路径找出来的路径，可能并不合适
    BGP寻求一条能够到达目的网络且相对较好的路由，并非寻找最佳路由，采用路径向量(path vector)路由选择协议
    
    在配置BGP时，每一个AS的管理员要选择至少一个路由器作为该AS的BGP发言人(BGP speaker)，通常为边界路由器，两个BGP发言人通过一个共享网络连接在一起
    两个BGP发言人交换路由信息时，先建立TCP连接，然后在该连接上交换BGP报文以建立BGP会话(session)，利用BGP会话交换路由信息
    这两个BGP发言人彼此称为对方的邻站(neighbor)或对等站(peer)
    
    BGP四种报文：(1). OPEN(打开)报文：用来与邻站建立关系，使通信初始化
                (2). UPDATE(更新)报文：用来通告某一路由的信息，以及列出要撤销的多条路由
                (3). KEEPALIVE(保活)报文：用来周期性地证实邻站的连通性
                (4). NOTIFICATION(通知)报文：用来发送检测到的差错
    由于BGP发言人可以从不止一个邻站获得路由信息，因此能很容易地解决坏消息传播得慢的问题
    
    BGP报文的首部包括标记、长度和类型
    
  6. 路由器的构成
     分为两大部分：路由选择部分和分组转发部分
     (1). 路由器的结构
       路由器是一种具有多个输入端口和多个输出端口的专用计算机，任务是转发分组
       从路由器某个输入端口收到的分组，按照分组要去的目的网络，把该分组从路由器的某个合适的输出端口转发给下一跳路由器，直到该分组到达终点为止
     (2). 路由选择部分称为控制部分，核心构件是路由选择处理机，其任务是根据所选定的路由选择协议构造出路由表，并且定期地和相邻路由器交换路由信息
     
     (3). 分组转发部分由三部分组成：交换结构、一组输入端口和一组输出端口
       1). 交换结构(switching fabric)，又称为交换组织
           其作用是根据转发表(forwarding table)对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去
           输入端口和输出端口里都有物理层、数据链路层和网络层的处理模块
             I. 物理层进行比特的接收
             II. 数据链路层按照链路层协议接收传送分组的帧，把首部和尾部剥去后，将分组传送到网络层的处理模块
             III. 若接收到的是数据分组，则按照首部中的目的地址查找转发表，找到合适的输出端口
                  若接收到的是路由器之间交换路由信息的分组，则把分组送交路由器的路由选择部分的路由选择处理机
       2). 交换结构的交换方法
         I. 通过存储器：当路由器的某个输入端口收到一个分组时，用中断方式通知路由选择处理机，将分组复制到存储器中
         II. 通过总线：数据报从输入端口通过共享的总线直接传送到合适的输出端口，不需要路由选择处理机的干预
         III. 通过互连网络，即通过纵横交换结构(crossbar switch fabric)：将输入端口收到的分组发送到与其相连的水平总线，通过垂直总线发到输出端口
         
         
         
         
         
